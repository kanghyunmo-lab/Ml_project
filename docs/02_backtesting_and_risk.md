# 백테스팅 및 리스크 관리 계획서 (v1.0)

**기준 문서:** PRD v1.1, 최종 실행 계획서

---

## 1. 개요
본 문서는 개발된 트레이딩 전략의 성능을 객관적으로 검증하고, 실제 운용 시 발생할 수 있는 리스크를 체계적으로 통제하기 위한 기술적, 절차적 표준을 정의합니다.

## 2. 백테스팅 프레임워크

### 2-1. 2단계 백테스팅 전략
- **1단계 (탐색):** VectorBT를 사용하여 수많은 피처 아이디어나 하이퍼파라미터 조합을 신속하게 테스트 (주로 notebooks/ 환경에서 진행)
- **2단계 (최종 검증):** 유망한 후보 전략은 반드시 Backtrader 기반의 이벤트 주도형(Event-Driven) 환경에서 재구현하여 최종 성능을 검증 (실거래 환경을 더 현실적으로 모사)

### 2-2. 백테스팅 엔진 요구사항 (src/backtesting/engine.py)
- **이벤트 주도형 아키텍처:** 미래 데이터 참조 편향(Look-ahead Bias)을 원천 차단하는 구조로 설계
- **현실적인 마찰 비용 모델링:**
    - **수수료:** 거래소의 수수료율(예: 0.04%)을 정확히 반영
    - **슬리피지:** ATR 기반의 가변적 슬리피지 모델을 적용, 변동성이 클 때 더 큰 슬리피지가 발생하도록 시뮬레이션
    - **펀딩비:** 8시간마다 발생하는 펀딩비를 포지션의 명목 가치 기준으로 계산하여 차감/수취

### 2-3. 핵심 성과 지표 (KPIs)
백테스트 결과 리포트는 반드시 PRD에 명시된 다음 지표들을 포함해야 합니다.
- 샤프 지수 (Sharpe Ratio)
- 칼마 지수 (Calmar Ratio)
- 최대 낙폭 (Maximum Drawdown, MDD)
- 워크 포워드 효율성 (WFE)
- 손익비 (Profit Factor)
- 연평균 복리 수익률 (CAGR)
- 승률 (Win Rate)

## 3. 리스크 관리 프레임워크

### 3-1. 포지션 사이징 (src/execution/risk_manager.py)
- **핵심 원칙:** '명목 가치 기반 2% 리스크' 규칙을 엄격히 준수
- **계산 절차:**
    1. 최대 손실액 계산: 전체 계좌 자본 × 2%
    2. 손절 거리 계산: | 진입가 - (2 × ATR 기반 손절가) |
    3. 포지션 규모 확정: 최대 손실액 ÷ 손절매 거리

### 3-2. 손절매 및 수익 실현 (src/execution/order_handler.py)
- **통합 관리:** 손절매와 수익 실현은 **'삼중 장벽 기법'**에 의해 통합적으로 관리
- **손절매 (Stop-Loss):** 2 x ATR 기반의 손절 가격을 설정
- **수익 실현 (Take-Profit):** 손절매 거리의 1.5배에 해당하는 가격을 익절 라인으로 설정하여, 손익비를 1:1.5로 고정
- **주문 방식:** 익절(Limit)과 손절(Stop) 주문을 동시에 실행하고 한쪽이 체결되면 다른 쪽은 자동 취소되는 OCO (One-Cancels-the-Other) 주문 사용을 원칙으로 함

### 3-3. 레버리지 및 청산 관리
- 상세 내용은 [문서 05] 레버리지 운용 전략을 따름
- '절대 청산 회피' 메커니즘을 risk_manager.py에 구현하여, 모든 주문 전에 청산 리스크를 검증
